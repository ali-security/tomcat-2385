name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '8'  # Java 7 minimum, but Java 8 is more commonly available
        distribution: 'temurin'  # Adoptium Temurin (formerly AdoptOpenJDK)
    
    - name: Set up Ant
      run: |
        ANT_VERSION=1.10.14
        wget https://archive.apache.org/dist/ant/binaries/apache-ant-${ANT_VERSION}-bin.tar.gz
        tar -xzf apache-ant-${ANT_VERSION}-bin.tar.gz
        sudo mv apache-ant-${ANT_VERSION} /opt/ant
        sudo ln -sf /opt/ant/bin/ant /usr/local/bin/ant
        echo "ANT_HOME=/opt/ant" >> $GITHUB_ENV
        echo "/opt/ant/bin" >> $GITHUB_PATH
        ant -version
    
    - name: Create build.properties
      run: |
        echo "base.path=$HOME/tomcat-build-libs" > build.properties
    
    - name: Build embed JARs
      run: ant package embed-jars
    
    - name: Run tests
      run: ant test
    
    # - name: Upload tomcat-embed-core JAR
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: tomcat-embed-core
    #     path: output/embed/tomcat-embed-core*.jar
    #     retention-days: 3
    